<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±èªå–®å­—ç²¾ç†Ÿå­¸ç¿’ç³»çµ± | Vocabulary Master</title>
    <!-- å¼•å…¥ Tailwind CSS é€²è¡Œå¿«é€Ÿåˆ‡ç‰ˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ FontAwesome åœ–ç¤º -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Roboto', 'Noto Sans TC', sans-serif;
            background-color: #f0fdf4; /* æ·ºç¶ è‰²èƒŒæ™¯ï¼Œè­·çœ¼ä¸”æ”¾é¬† */
            touch-action: manipulation; /* å„ªåŒ–è§¸æ§ */
        }

        /* ç¿»è½‰å¡ç‰‡ç‰¹æ•ˆ */
        .perspective-1000 {
            perspective: 1000px;
        }
        .transform-style-3d {
            transform-style: preserve-3d;
        }
        .backface-hidden {
            backface-visibility: hidden;
        }
        .rotate-y-180 {
            transform: rotateY(180deg);
        }

        /* éŒ„éŸ³æ³¢ç´‹å‹•ç•« */
        .recording-pulse {
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* éŠæˆ²é…å°å¡ç‰‡ */
        .game-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .game-card.matched {
            visibility: hidden;
            opacity: 0;
        }
        
        /* è‡ªå®šç¾©æ²è»¸ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }

        /* æ–°å¢ï¼šçµç®—è¦–çª—å‹•ç•« */
        @keyframes bounce-in {
            0% { transform: scale(0.9); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-bounce-in {
            animation: bounce-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        
        /* éœ‡å‹•ç‰¹æ•ˆ (éŒ¯èª¤æ™‚) */
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- é ‚éƒ¨å°èˆªèˆ‡æ¨™é¡Œ -->
    <header class="bg-teal-600 text-white shadow-lg z-10">
        <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-lg font-bold flex items-center gap-2">
                <i class="fas fa-graduation-cap"></i>
                å–®å­—ç²¾ç†Ÿç³»çµ± <span class="text-xs bg-teal-700 px-2 py-1 rounded hidden sm:inline-block">Unit 4 (Demo)</span>
            </h1>
            <div class="text-xs sm:text-sm bg-teal-700 px-3 py-1 rounded-full">
                <i class="fas fa-user-circle mr-1"></i> å­¸ç”Ÿæ¨¡å¼
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å…§å®¹å€ (å¯æ²å‹•) -->
    <main class="flex-1 overflow-y-auto bg-gray-50 relative w-full max-w-4xl mx-auto shadow-xl" id="app-container">
        
        <!-- é é¢ 1: å–®å­—å¡å­¸ç¿’ (Flashcards) -->
        <section id="page-learn" class="p-4 flex flex-col items-center justify-center min-h-full">
            
            <!-- é€²åº¦æ¢èˆ‡ç¯©é¸é–‹é—œ -->
            <div class="w-full max-w-md mb-4">
                <div class="flex justify-between items-end mb-2">
                    <div class="text-xs text-gray-500">
                        <span id="progress-text">å–®å­— 1 / 28</span>
                        <span id="learned-badge" class="hidden ml-2 text-green-600 font-bold bg-green-100 px-2 py-0.5 rounded-full text-xs"><i class="fas fa-check-circle"></i> å·²å­¸æœƒ</span>
                    </div>
                    
                    <!-- æ–°å¢ï¼šç¯©é¸é–‹é—œ -->
                    <label class="flex items-center cursor-pointer select-none">
                        <input type="checkbox" id="filter-toggle" class="sr-only peer" onchange="toggleFilterMode()">
                        <div class="relative w-9 h-5 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-teal-600"></div>
                        <span class="ms-2 text-xs font-medium text-gray-600">åªç·´ç¿’ä¸ç†Ÿçš„</span>
                    </label>
                </div>
                
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="progress-bar" class="bg-teal-500 h-2 rounded-full transition-all duration-300" style="width: 3%"></div>
                </div>
            </div>

            <!-- å¡ç‰‡æœ¬é«” -->
            <div class="relative w-full max-w-md h-80 perspective-1000 group cursor-pointer" onclick="flipCard()">
                <div id="flashcard-inner" class="relative w-full h-full text-center transition-all duration-500 transform-style-3d shadow-xl rounded-2xl">
                    
                    <!-- æ­£é¢ (è‹±æ–‡) -->
                    <div class="absolute w-full h-full bg-white rounded-2xl backface-hidden flex flex-col items-center justify-center border-2 border-gray-100">
                        <span id="card-pos-front" class="absolute top-4 right-4 text-xs font-mono bg-gray-100 text-gray-500 px-2 py-1 rounded">vt.</span>
                        <h2 id="card-word" class="text-4xl font-bold text-gray-800 mb-4 tracking-wide">word</h2>
                        <button onclick="event.stopPropagation(); playAudio()" class="w-12 h-12 rounded-full bg-teal-100 text-teal-600 hover:bg-teal-200 flex items-center justify-center transition-colors shadow-sm">
                            <i class="fas fa-volume-up text-xl"></i>
                        </button>
                        <p class="text-gray-400 text-sm mt-4 animate-pulse"><i class="fas fa-sync-alt mr-1"></i> é»æ“Šç¿»å¡æŸ¥çœ‹å­—ç¾©</p>
                    </div>

                    <!-- èƒŒé¢ (ä¸­æ–‡) -->
                    <div class="absolute w-full h-full bg-teal-50 rounded-2xl backface-hidden rotate-y-180 flex flex-col items-center justify-center border-2 border-teal-100 px-6">
                        <span id="card-pos-back" class="inline-block bg-teal-200 text-teal-800 text-xs px-2 py-1 rounded mb-3">vt.</span>
                        <h3 id="card-meaning" class="text-3xl font-bold text-gray-800 mb-4">å–®å­—æ„æ€</h3>
                        <div id="card-collocation-box" class="bg-white px-4 py-2 rounded-lg border border-teal-200 mt-2 hidden">
                            <p class="text-xs text-gray-500 mb-1">å¸¸è¦‹æ­é…</p>
                            <p id="card-collocation" class="text-teal-700 font-medium text-sm">make a record</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ–°å¢ï¼šç†Ÿæ‚‰åº¦æ¨™è¨˜æŒ‰éˆ• (æ”¾åœ¨å¡ç‰‡ä¸‹æ–¹) -->
            <div class="flex gap-3 w-full max-w-md mt-4 mb-2">
                <button id="btn-unknown" onclick="markCurrentWord(false)" class="flex-1 py-2 rounded-full border border-red-200 text-red-500 bg-white hover:bg-red-50 font-bold transition shadow-sm flex items-center justify-center gap-2">
                    <i class="fas fa-times"></i> é‚„ä¸ç†Ÿ
                </button>
                <button id="btn-known" onclick="markCurrentWord(true)" class="flex-1 py-2 rounded-full border border-green-200 text-green-500 bg-white hover:bg-green-50 font-bold transition shadow-sm flex items-center justify-center gap-2">
                    <i class="fas fa-check"></i> å·²å­¸æœƒ
                </button>
            </div>

            <!-- æ§åˆ¶å€ (ä¿®æ”¹ï¼šæ”¹ç‚º 4 æ¬„ä»¥å®¹ç´éš¨æ©ŸæŒ‰éˆ•) -->
            <div class="w-full max-w-md mt-2 grid grid-cols-4 gap-2">
                <button onclick="prevWord()" class="py-3 rounded-lg bg-gray-200 text-gray-600 font-medium hover:bg-gray-300 transition flex flex-col sm:flex-row items-center justify-center gap-1">
                    <i class="fas fa-arrow-left"></i> <span class="text-xs sm:text-base">ä¸Šä¸€å€‹</span>
                </button>
                
                <!-- æ–°å¢ï¼šéš¨æ©ŸæŒ‰éˆ• -->
                <button onclick="randomWord()" class="py-3 rounded-lg bg-indigo-100 text-indigo-600 font-medium hover:bg-indigo-200 transition flex flex-col sm:flex-row items-center justify-center gap-1">
                    <i class="fas fa-random"></i> <span class="text-xs sm:text-base">éš¨æ©Ÿ</span>
                </button>

                <!-- éŒ„éŸ³æŒ‰éˆ• -->
                <button id="record-btn" onclick="toggleRecording()" class="py-3 rounded-lg bg-red-100 text-red-500 font-medium hover:bg-red-200 transition flex flex-col sm:flex-row items-center justify-center gap-1 border border-red-200">
                    <i class="fas fa-microphone"></i> <span id="record-text" class="text-xs sm:text-base">è·Ÿè®€</span>
                </button>

                <button onclick="nextWord()" class="py-3 rounded-lg bg-teal-600 text-white font-medium hover:bg-teal-700 transition shadow-lg flex flex-col sm:flex-row items-center justify-center gap-1">
                    <span class="text-xs sm:text-base">ä¸‹ä¸€å€‹</span> <i class="fas fa-arrow-right"></i>
                </button>
            </div>

            <!-- éŒ„éŸ³å›é¥‹å€ -->
            <div id="feedback-area" class="h-6 mt-4 text-center text-sm font-medium text-transparent transition-all">
                ç­‰å¾…å›é¥‹...
            </div>
            
            <!-- æ–°å¢ï¼šæ’­æ”¾éŒ„éŸ³æŒ‰éˆ• (é è¨­éš±è—) -->
            <button id="play-user-audio-btn" onclick="playUserAudio()" class="hidden mt-3 px-4 py-2 bg-blue-100 text-blue-600 rounded-full text-sm font-bold hover:bg-blue-200 transition flex items-center justify-center mx-auto gap-2 shadow-sm">
                <i class="fas fa-play-circle"></i> è½è½è‡ªå·±çš„ç™¼éŸ³
            </button>

        </section>

        <!-- é é¢ 2: é—–é—œéŠæˆ² (Games) -->
        <section id="page-game" class="hidden p-4 min-h-full">
            <div class="max-w-md mx-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-gamepad text-teal-500 mr-2"></i> é¸æ“‡æŒ‘æˆ°é—œå¡
                </h2>
                
                <!-- é—œå¡é¸å–® -->
                <div id="game-menu" class="grid grid-cols-1 gap-4">
                    <div onclick="startGame(1)" class="bg-white p-5 rounded-xl shadow-md border-l-4 border-blue-400 cursor-pointer hover:shadow-lg transition flex items-center">
                        <div class="bg-blue-100 p-3 rounded-full mr-4 text-blue-600"><i class="fas fa-eye"></i></div>
                        <div>
                            <h3 class="font-bold text-lg">ç¬¬ 1 é—œï¼šçœ¼æ˜æ‰‹å¿«</h3>
                            <p class="text-sm text-gray-500">çœ‹è‹±æ–‡é¸ä¸­æ–‡ï¼Œæ¸¬è©¦ä½ çš„ç›´è¦ºåæ‡‰ï¼</p>
                        </div>
                    </div>
                    
                    <div onclick="startGame(2)" class="bg-white p-5 rounded-xl shadow-md border-l-4 border-purple-400 cursor-pointer hover:shadow-lg transition flex items-center">
                        <div class="bg-purple-100 p-3 rounded-full mr-4 text-purple-600"><i class="fas fa-puzzle-piece"></i></div>
                        <div>
                            <h3 class="font-bold text-lg">ç¬¬ 2 é—œï¼šè¨˜æ†¶é…å°</h3>
                            <p class="text-sm text-gray-500">ç¿»ç‰Œé…å°è‹±æ–‡èˆ‡ä¸­æ–‡ï¼Œè€ƒé©—è¨˜æ†¶åŠ›ï¼</p>
                        </div>
                    </div>

                    <!-- æ–°å¢ï¼šç¬¬ 3 é—œæŒ‰éˆ• -->
                    <div onclick="startGame(3)" class="bg-white p-5 rounded-xl shadow-md border-l-4 border-orange-400 cursor-pointer hover:shadow-lg transition flex items-center">
                        <div class="bg-orange-100 p-3 rounded-full mr-4 text-orange-600"><i class="fas fa-keyboard"></i></div>
                        <div>
                            <h3 class="font-bold text-lg">ç¬¬ 3 é—œï¼šæ‹¼å­—å¤§å¸«</h3>
                            <p class="text-sm text-gray-500">çœ‹ä¸­æ–‡æ‹¼è‹±æ–‡ï¼ŒæŒ‘æˆ°ä½ çš„ç²¾ç†Ÿåº¦ï¼</p>
                        </div>
                    </div>
                </div>

                <!-- éŠæˆ²å€åŸŸ Level 1 (é¸æ“‡é¡Œ) -->
                <div id="game-level-1" class="hidden">
                    <div class="flex justify-between items-center mb-4 bg-blue-50 p-3 rounded-lg">
                        <div class="flex gap-4">
                            <span class="font-bold text-blue-800">Score: <span id="g1-score">0</span></span>
                            <span class="font-bold text-blue-600">é¡Œè™Ÿ: <span id="g1-progress">1/10</span></span>
                        </div>
                        <button onclick="exitGame()" class="text-xs text-gray-500 underline">é€€å‡ºéŠæˆ²</button>
                    </div>
                    
                    <div class="bg-white p-8 rounded-2xl shadow-lg text-center mb-6">
                        <h3 id="g1-question" class="text-3xl font-bold text-gray-800 mb-2">Question</h3>
                        <span id="g1-pos" class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500">pos</span>
                    </div>

                    <div id="g1-options" class="grid grid-cols-1 gap-3">
                        <!-- é¸é …ç”± JS ç”Ÿæˆ -->
                    </div>
                    <div id="g1-feedback" class="mt-4 text-center font-bold h-6"></div>
                </div>

                <!-- éŠæˆ²å€åŸŸ Level 2 (é…å°) -->
                <div id="game-level-2" class="hidden">
                    <div class="flex justify-between items-center mb-4 bg-purple-50 p-3 rounded-lg">
                        <span class="font-bold text-purple-800">å‰©é¤˜çµ„æ•¸: <span id="g2-left">6</span></span>
                        <span id="g2-timer" class="font-mono text-gray-600">00:00</span>
                        <button onclick="exitGame()" class="text-xs text-gray-500 underline">é€€å‡º</button>
                    </div>
                    
                    <div id="g2-grid" class="grid grid-cols-3 gap-2 sm:gap-4">
                        <!-- å¡ç‰‡ç”± JS ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- æ–°å¢ï¼šéŠæˆ²å€åŸŸ Level 3 (æ‹¼å­—) -->
                <div id="game-level-3" class="hidden">
                    <div class="flex justify-between items-center mb-4 bg-orange-50 p-3 rounded-lg">
                        <div class="flex gap-4">
                            <span class="font-bold text-orange-800">Score: <span id="g3-score">0</span></span>
                            <span class="font-bold text-orange-600">é¡Œè™Ÿ: <span id="g3-progress">1/5</span></span>
                        </div>
                        <button onclick="exitGame()" class="text-xs text-gray-500 underline">é€€å‡ºéŠæˆ²</button>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-lg text-center mb-6">
                        <span id="g3-pos" class="inline-block bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded mb-2 font-mono">pos</span>
                        <h3 id="g3-meaning" class="text-2xl font-bold text-gray-800 mb-6">ä¸­æ–‡æ„æ€</h3>
                        
                        <div class="relative max-w-xs mx-auto">
                            <input type="text" id="g3-input" class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg focus:outline-none focus:border-orange-500 text-center font-bold text-gray-700 tracking-wide" placeholder="è«‹è¼¸å…¥å–®å­—" autocomplete="off">
                        </div>
                    </div>

                    <div class="flex flex-col gap-3">
                        <button onclick="checkAnswerG3()" class="w-full py-3 bg-orange-500 hover:bg-orange-600 text-white font-bold rounded-xl shadow transition">é€å‡ºç­”æ¡ˆ (Submit)</button>
                        <div id="g3-feedback" class="text-center font-bold h-6 text-sm"></div>
                    </div>
                </div>

            </div>
        </section>

        <!-- é é¢ 3: å­¸ç¿’æ­·ç¨‹ (Stats) -->
        <section id="page-stats" class="hidden p-6 min-h-full">
            <div class="max-w-md mx-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-chart-line text-teal-500 mr-2"></i> å­¸ç¿’æˆæœçœ‹æ¿
                </h2>

                <!-- ç¸½è¦½å¡ç‰‡ -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-xl shadow border border-gray-100 text-center">
                        <div class="text-3xl font-bold text-teal-600" id="stat-learned">0</div>
                        <div class="text-xs text-gray-500">å·²å­¸ç¿’å–®å­—æ•¸</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow border border-gray-100 text-center">
                        <div class="text-3xl font-bold text-blue-600" id="stat-speech">0</div>
                        <div class="text-xs text-gray-500">ç™¼éŸ³ç·´ç¿’æ¬¡æ•¸</div>
                    </div>
                </div>

                <!-- æ–°å¢ï¼šå·²æŒæ¡å–®å­—è©³ç´°åˆ—è¡¨ -->
                <div class="bg-white rounded-xl shadow border border-gray-100 overflow-hidden mb-6">
                    <div class="bg-gray-50 px-4 py-3 border-b border-gray-100 font-bold text-gray-700 flex justify-between items-center">
                        <span>å·²æŒæ¡å–®å­—åˆ—è¡¨</span>
                        <span class="text-xs text-gray-400 font-normal">æ¨™è¨˜ã€Œå·²å­¸æœƒã€å°‡é¡¯ç¤ºæ–¼æ­¤</span>
                    </div>
                    <div class="p-4 max-h-60 overflow-y-auto custom-scrollbar">
                        <div id="learned-word-list" class="flex flex-wrap gap-2">
                            <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                            <span class="text-gray-400 text-sm">å°šæœªé–‹å§‹å­¸ç¿’...</span>
                        </div>
                    </div>
                </div>

                <!-- è©³ç´°æ¸…å–® -->
                <div class="bg-white rounded-xl shadow border border-gray-100 overflow-hidden">
                    <div class="bg-gray-50 px-4 py-3 border-b border-gray-100 font-bold text-gray-700">
                        å­¸ç¿’æ­·ç¨‹ç´€éŒ„
                    </div>
                    <div class="p-4">
                        <ul id="history-list" class="space-y-3 text-sm">
                            <li class="text-gray-400 text-center py-4">ç›®å‰å°šç„¡ç´€éŒ„ï¼Œå¿«å»ç·´ç¿’å§ï¼</li>
                        </ul>
                    </div>
                </div>

                <button onclick="resetProgress()" class="mt-8 w-full py-3 text-gray-400 text-xs border border-gray-200 rounded hover:bg-red-50 hover:text-red-500 transition">
                    æ¸…é™¤æ‰€æœ‰å­¸ç¿’ç´€éŒ„ (é‡ç½®)
                </button>
            </div>
        </section>

    </main>

    <!-- æ–°å¢ï¼šéŠæˆ²çµç®— Modal (å–ä»£ alert) -->
    <div id="game-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full mx-4 shadow-2xl transform transition-all scale-100 animate-bounce-in text-center relative border-4 border-white">
            <div class="absolute -top-10 left-1/2 transform -translate-x-1/2 bg-yellow-400 p-4 rounded-full border-4 border-white shadow-lg">
                <i class="fas fa-trophy text-3xl text-white"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mt-8 mb-2">æ­å–œé€šé—œï¼</h3>
            <div class="py-4 space-y-3">
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-100">
                    <!-- ä¿®æ”¹ï¼šçµ¦æ¨™é¡Œå’Œå…§å®¹åŠ ä¸Š ID ä»¥ä¾¿ JS å‹•æ…‹åˆ‡æ›é¡¯ç¤º åˆ†æ•¸/æ™‚é–“ -->
                    <p id="modal-label" class="text-xs text-gray-500 uppercase tracking-wide font-bold">ç¸½è€—æ™‚</p>
                    <p id="modal-value" class="text-3xl font-mono font-bold text-teal-600">00:00</p>
                </div>
                <div class="bg-blue-50 rounded-lg p-3 text-left border-l-4 border-blue-400">
                    <p class="text-xs text-blue-500 font-bold mb-1">è€å¸«è©•èªï¼š</p>
                    <p id="modal-feedback" class="text-sm text-blue-800 font-medium leading-relaxed">Loading...</p>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="retryGame()" class="py-3 px-4 bg-gray-100 text-gray-600 rounded-xl hover:bg-gray-200 font-bold transition">å†ç©ä¸€æ¬¡</button>
                <button onclick="closeModalAndExit()" class="py-3 px-4 bg-teal-600 text-white rounded-xl hover:bg-teal-700 font-bold transition shadow-lg">å›åˆ°é¸å–®</button>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å°èˆªåˆ— -->
    <nav class="bg-white border-t border-gray-200 safe-bottom">
        <div class="max-w-4xl mx-auto flex justify-around">
            <button onclick="switchPage('learn')" class="nav-btn active flex-1 py-3 text-center text-gray-400 hover:text-teal-600 transition flex flex-col items-center gap-1 text-xs">
                <i class="fas fa-book-open text-lg"></i>
                <span>å–®å­—å¡</span>
            </button>
            <button onclick="switchPage('game')" class="nav-btn flex-1 py-3 text-center text-gray-400 hover:text-teal-600 transition flex flex-col items-center gap-1 text-xs">
                <i class="fas fa-gamepad text-lg"></i>
                <span>é—–é—œæŒ‘æˆ°</span>
            </button>
            <button onclick="switchPage('stats')" class="nav-btn flex-1 py-3 text-center text-gray-400 hover:text-teal-600 transition flex flex-col items-center gap-1 text-xs">
                <i class="fas fa-chart-pie text-lg"></i>
                <span>å­¸ç¿’æ­·ç¨‹</span>
            </button>
        </div>
    </nav>

    <!-- JavaScript é‚è¼¯ -->
    <script>
        // --- 1. è³‡æ–™åº« (Data Source) ---
        const vocabData = [
            { id: 1, word: "individual", pos: "adj.", meaning: "å€‹åˆ¥çš„" },
            { id: 2, word: "individual", pos: "n. [C]", meaning: "å€‹äºº" },
            { id: 3, word: "record", pos: "vt.; vi.", meaning: "éŒ„å½±ï¼›éŒ„éŸ³" },
            { id: 4, word: "record", pos: "vt.", meaning: "è¨˜éŒ„" },
            { id: 5, word: "record", pos: "n. [C]", meaning: "ç´€éŒ„" },
            { id: 6, word: "rearrange", pos: "vt.", meaning: "é‡æ–°å®‰æ’ï¼›é‡æ–°å¸ƒç½®" },
            { id: 7, word: "arrange", pos: "vt.", meaning: "å®‰æ’ï¼›å¸ƒç½®" },
            { id: 8, word: "seize", pos: "vt.", meaning: "æŠŠæ¡ï¼›æŠ“ä½" },
            { id: 9, word: "intensive", pos: "adj.", meaning: "å¯†é›†çš„" },
            { id: 10, word: "typical", pos: "adj.", meaning: "å…¸å‹çš„" },
            { id: 11, word: "routine", pos: "n. [C][U]", meaning: "ä¾‹è¡Œå…¬äº‹ï¼›æ—¥å¸¸ä½œæ¯" },
            { id: 12, word: "professional", pos: "adj.", meaning: "è·æ¥­çš„ï¼›å°ˆæ¥­çš„" },
            { id: 13, word: "electronic", pos: "adj.", meaning: "é›»å­çš„" },
            { id: 14, word: "advance", pos: "vt.; vi.", meaning: "é€²æ­¥ï¼›é€²å±•" },
            { id: 15, word: "advance", pos: "n. [C][U]", meaning: "é€²æ­¥ï¼›é€²å±•" },
            { id: 16, word: "sufficient", pos: "adj.", meaning: "è¶³å¤ çš„" },
            { id: 17, word: "equipment", pos: "n. [U]", meaning: "è¨­å‚™ï¼›è£å‚™" },
            { id: 18, word: "equip", pos: "vt.", meaning: "é…å‚™ï¼›è£å‚™" },
            { id: 19, word: "ideal", pos: "adj.", meaning: "ç†æƒ³çš„" },
            { id: 20, word: "broadcast", pos: "vt.; vi.", meaning: "æ’­é€ï¼›å»£æ’­" },
            { id: 21, word: "broadcast", pos: "n. [C]", meaning: "ï¼ˆé›»è¦–ï¼å»£æ’­ï¼‰ç¯€ç›®" },
            { id: 22, word: "global", pos: "adj.", meaning: "å…¨çƒçš„ï¼›å…¨ä¸–ç•Œçš„" },
            { id: 23, word: "overseas", pos: "adv.", meaning: "åœ¨æµ·å¤–" },
            { id: 24, word: "sacrifice", pos: "vt.", meaning: "çŠ§ç‰²" },
            { id: 25, word: "sacrifice", pos: "n. [C][U]", meaning: "çŠ§ç‰²" },
            { id: 26, word: "imagine", pos: "vt.", meaning: "æƒ³åƒ" },
            { id: 27, word: "imagination", pos: "n. [C][U]", meaning: "æƒ³åƒåŠ›" },
            { id: 28, word: "have no choice but to", pos: "phr.", meaning: "ä¸å¾—ä¸" },
            { id: 29, word: "make it up to sb", pos: "phr.", meaning: "è£œå„ŸæŸäºº" },
            { id: 30, word: "stand for", pos: "phr.", meaning: "ä»£è¡¨" },
            { id: 31, word: "key to", pos: "phr.", meaning: "â€¦â€¦çš„é—œéµ" },
            { id: 32, word: "make a living", pos: "phr.", meaning: "è¬€ç”Ÿ" },
            { id: 33, word: "as a matter of fact", pos: "phr.", meaning: "äº‹å¯¦ä¸Šï¼›å…¶å¯¦" },
            { id: 34, word: "at least", pos: "phr.", meaning: "è‡³å°‘" }
        ];

        // --- 2. ç‹€æ…‹ç®¡ç† (State) ---
        let currentIndex = 0;
        let isFlipped = false;
        let isFilterMode = false; // æ–°å¢ï¼šæ˜¯å¦åªé¡¯ç¤ºä¸ç†Ÿå–®å­—
        let userData = {
            learned: [], // å­˜ idï¼Œä»£è¡¨å·²ç†Ÿè¨˜ (Known)
            speechCount: 0,
            history: [] // { date: string, action: string }
        };

        // --- 3. åˆå§‹åŒ– ---
        window.onload = () => {
            loadUserData();
            renderCard();
            updateStats();
            
            // ç›£è½ Level 3 è¼¸å…¥æ¡† Enter éµ
            document.getElementById('g3-input').addEventListener('keypress', function(e) {
                if(e.key === 'Enter') checkAnswerG3();
            });
        };

        function loadUserData() {
            const saved = localStorage.getItem('vocabMasterData');
            if (saved) {
                userData = JSON.parse(saved);
            }
        }

        function saveData() {
            localStorage.setItem('vocabMasterData', JSON.stringify(userData));
            updateStats();
        }

        // --- 4. é é¢åˆ‡æ›é‚è¼¯ ---
        function switchPage(pageId) {
            // éš±è—æ‰€æœ‰é é¢
            document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
            // é¡¯ç¤ºç›®æ¨™é é¢
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            
            // æ›´æ–°åº•éƒ¨æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-teal-600', 'font-bold');
                btn.classList.add('text-gray-400');
            });
            // é»æ“Šçš„æŒ‰éˆ•é«˜äº®
            const btnMap = { 'learn': 0, 'game': 1, 'stats': 2 };
            const btns = document.querySelectorAll('.nav-btn');
            btns[btnMap[pageId]].classList.remove('text-gray-400');
            btns[btnMap[pageId]].classList.add('text-teal-600', 'font-bold');

            if(pageId === 'stats') renderHistory();
        }

        // --- 5. å–®å­—å¡åŠŸèƒ½ (Flashcard) ---
        function renderCard() {
            const data = vocabData[currentIndex];
            const inner = document.getElementById('flashcard-inner');
            
            // é‡ç½®ç¿»é¢ç‹€æ…‹
            isFlipped = false;
            inner.classList.remove('rotate-y-180');
            
            // å¡«å……å…§å®¹
            document.getElementById('card-word').textContent = data.word;
            document.getElementById('card-pos-front').textContent = data.pos;
            document.getElementById('card-pos-back').textContent = data.pos;
            document.getElementById('card-meaning').textContent = data.meaning;
            
            // æ­é…è©
            document.getElementById('card-collocation-box').classList.add('hidden');

            // é€²åº¦æ›´æ–° (ç¾åœ¨åŸºæ–¼å·²å­¸æœƒæ•¸é‡)
            document.getElementById('progress-text').textContent = `å–®å­— ${currentIndex + 1} / ${vocabData.length}`;
            const pct = (userData.learned.length / vocabData.length) * 100;
            document.getElementById('progress-bar').style.width = `${pct}%`;

            // æ›´æ–°æŒ‰éˆ•èˆ‡æ¨™è¨˜ç‹€æ…‹
            updateFamiliarityUI(data.id);
        }
        
        // æ–°å¢ï¼šæ›´æ–°ç†Ÿæ‚‰åº¦æŒ‰éˆ•èˆ‡æ¨™è¨˜çš„é¡¯ç¤º
        function updateFamiliarityUI(id) {
            const isKnown = userData.learned.includes(id);
            const badge = document.getElementById('learned-badge');
            const btnKnown = document.getElementById('btn-known');
            const btnUnknown = document.getElementById('btn-unknown');

            if (isKnown) {
                badge.classList.remove('hidden');
                // æŒ‰éˆ•æ¨£å¼è®ŠåŒ–ï¼šå·²å­¸æœƒè®Šç¶ è‰²å¯¦å¿ƒ
                btnKnown.classList.remove('bg-white', 'text-green-500');
                btnKnown.classList.add('bg-green-500', 'text-white');
                // é‚„ä¸ç†Ÿè®Šå›é è¨­
                btnUnknown.classList.remove('bg-red-500', 'text-white');
                btnUnknown.classList.add('bg-white', 'text-red-500');
            } else {
                badge.classList.add('hidden');
                // æŒ‰éˆ•æ¨£å¼è®ŠåŒ–ï¼šé‚„ä¸ç†Ÿå¯è¦–ç‚ºé è¨­ç‹€æ…‹æˆ–å¼·èª¿
                btnKnown.classList.remove('bg-green-500', 'text-white');
                btnKnown.classList.add('bg-white', 'text-green-500');
                // é€™è£¡æˆ‘å€‘ä¸å¼·åˆ¶è®“"é‚„ä¸ç†Ÿ"äº®èµ·ï¼Œä¿æŒæ¸…çˆ½ï¼Œé™¤éæœ‰é»æ“Šäº’å‹•
            }
        }

        // æ–°å¢ï¼šæ¨™è¨˜ç•¶å‰å–®å­—ç†Ÿæ‚‰åº¦
        function markCurrentWord(isKnown) {
            const currentId = vocabData[currentIndex].id;
            
            if (isKnown) {
                if (!userData.learned.includes(currentId)) {
                    userData.learned.push(currentId);
                    saveData();
                    updateFamiliarityUI(currentId);
                    
                    // å¦‚æœåœ¨ã€Œåªç·´ç¿’ä¸ç†Ÿã€æ¨¡å¼ï¼Œè‡ªå‹•è·³ä¸‹ä¸€å¼µ
                    if (isFilterMode) {
                        setTimeout(() => {
                            nextWord();
                        }, 500);
                    }
                }
            } else {
                // æ¨™è¨˜ç‚ºä¸ç†Ÿ (å¾ learned ç§»é™¤)
                if (userData.learned.includes(currentId)) {
                    userData.learned = userData.learned.filter(id => id !== currentId);
                    saveData();
                    updateFamiliarityUI(currentId);
                }
            }
        }

        // æ–°å¢ï¼šåˆ‡æ›ç¯©é¸æ¨¡å¼
        function toggleFilterMode() {
            const toggle = document.getElementById('filter-toggle');
            isFilterMode = toggle.checked;
            
            // å¦‚æœç•¶å‰å–®å­—å·²å­¸æœƒï¼Œä¸”åˆ‡æ›åˆ°éæ¿¾æ¨¡å¼ï¼Œè‡ªå‹•è·³åˆ°ä¸‹ä¸€å€‹ä¸ç†Ÿçš„
            if (isFilterMode && userData.learned.includes(vocabData[currentIndex].id)) {
                nextWord();
            }
        }

        function flipCard() {
            const inner = document.getElementById('flashcard-inner');
            isFlipped = !isFlipped;
            if (isFlipped) {
                inner.classList.add('rotate-y-180');
            } else {
                inner.classList.remove('rotate-y-180');
            }
        }

        function nextWord() {
            let nextIndex = currentIndex;
            let loopCount = 0;
            const maxLoop = vocabData.length;

            // å°‹æ‰¾ä¸‹ä¸€å€‹
            do {
                nextIndex++;
                if (nextIndex >= vocabData.length) {
                    // è‹¥åˆ°åº•ï¼Œæª¢æŸ¥æ¨¡å¼
                    if (isFilterMode) {
                        // å¦‚æœæ‰€æœ‰å–®å­—éƒ½å­¸æœƒäº†
                        if (userData.learned.length === vocabData.length) {
                            alert("å¤ªæ£’äº†ï¼ä½ å·²ç¶“å­¸æœƒæ‰€æœ‰å–®å­—äº†ï¼\nå»ºè­°å¯ä»¥é‡ç½®å­¸ç¿’ç´€éŒ„ï¼Œæˆ–å‰å¾€é—–é—œéŠæˆ²æŒ‘æˆ°ã€‚");
                            return; 
                        }
                        // å¾ªç’°å›åˆ°é–‹é ­ç¹¼çºŒæ‰¾
                        nextIndex = 0;
                    } else {
                        // æ­£å¸¸æ¨¡å¼åˆ°åº•å°±åœæˆ–æç¤º
                        alert("æ­å–œï¼ä½ å·²ç¶“ç€è¦½å®Œæ‰€æœ‰å–®å­—äº†ï¼");
                        return;
                    }
                }
                
                loopCount++;
                // é˜²æ­¢ç„¡é™è¿´åœˆ
                if (loopCount > maxLoop) break;

            } while (isFilterMode && userData.learned.includes(vocabData[nextIndex].id));

            // å¦‚æœæ‰¾åˆ°äº†åˆé©çš„å–®å­—
            if (nextIndex < vocabData.length) {
                currentIndex = nextIndex;
                renderCard();
            }
        }

        function prevWord() {
            let prevIndex = currentIndex;
            let loopCount = 0;
            const maxLoop = vocabData.length;

            do {
                prevIndex--;
                if (prevIndex < 0) {
                     if (isFilterMode) {
                        prevIndex = vocabData.length - 1;
                     } else {
                        return; // å·²ç¶“æ˜¯ç¬¬ä¸€å€‹
                     }
                }
                
                loopCount++;
                if (loopCount > maxLoop) break;
            } while (isFilterMode && userData.learned.includes(vocabData[prevIndex].id));

             if (prevIndex >= 0) {
                currentIndex = prevIndex;
                renderCard();
            }
        }

        // æ–°å¢ï¼šéš¨æ©Ÿå–®å­—åŠŸèƒ½ (æ”¯æ´ç¯©é¸)
        function randomWord() {
            // æ‰¾å‡ºæ‰€æœ‰ç¬¦åˆæ¢ä»¶çš„ candidates
            let candidates = [];
            
            vocabData.forEach((item, index) => {
                // å¦‚æœæ˜¯ç¯©é¸æ¨¡å¼ï¼Œä¸”è©²å­—å·²å­¸æœƒï¼Œå‰‡ä¸åŠ å…¥å€™é¸
                if (isFilterMode && userData.learned.includes(item.id)) {
                    return;
                }
                // æ’é™¤ç•¶å‰å–®å­— (é™¤éåªæœ‰é€™ä¸€å€‹å€™é¸)
                if (index !== currentIndex) {
                    candidates.push(index);
                }
            });
            
            // å¦‚æœæ‰€æœ‰å­—éƒ½å­¸æœƒäº†
            if (candidates.length === 0) {
                if (isFilterMode) {
                     // æª¢æŸ¥æ˜¯å¦ç•¶å‰å­—ä¹Ÿæ˜¯å·²å­¸æœƒ (å”¯ä¸€å‰©ä¸‹çš„)
                     if (!userData.learned.includes(vocabData[currentIndex].id)) {
                         // åªå‰©ç•¶å‰é€™å­—æ²’å­¸æœƒï¼Œä¸å‹•ä½œ
                         alert("åªå‰©é€™å€‹å–®å­—é‚„æ²’å­¸æœƒå›‰ï¼åŠ æ²¹ï¼");
                     } else {
                         alert("å¤ªæ£’äº†ï¼ä½ å·²ç¶“å­¸æœƒæ‰€æœ‰å–®å­—äº†ï¼");
                     }
                } else {
                     // ä¸€èˆ¬æ¨¡å¼ä¸‹å¦‚æœåªæœ‰ä¸€å€‹å­—
                     if(vocabData.length <= 1) return;
                     // éš¨æ©Ÿè·³
                     let newIdx = Math.floor(Math.random() * vocabData.length);
                     while(newIdx === currentIndex) newIdx = Math.floor(Math.random() * vocabData.length);
                     currentIndex = newIdx;
                     renderCard();
                }
                return;
            }

            const randomIndex = candidates[Math.floor(Math.random() * candidates.length)];
            currentIndex = randomIndex;
            renderCard();
        }

        // --- 5.1 éŸ³è¨Šèˆ‡éŒ„éŸ³ (Audio & Recording) ---
        function playAudio() {
            const word = vocabData[currentIndex].word;
            // ä½¿ç”¨ç€è¦½å™¨å…§å»º Web Speech API
            const utterance = new SpeechSynthesisUtterance(word);
            utterance.lang = 'en-US';
            utterance.rate = 0.9; // ç¨å¾®æ”¾æ…¢
            window.speechSynthesis.speak(utterance);
        }

        // çœŸå¯¦èªéŸ³è¾¨è­˜é‚è¼¯
        let recognition = null;
        let isRecording = false;
        
        let mediaRecorder = null;
        let audioChunks = [];
        let audioURL = null;

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechAPI();
            recognition.lang = 'en-US';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                const targetWord = vocabData[currentIndex].word;
                evaluatePronunciation(transcript, targetWord);
                stopRecordingUI();
            };

            recognition.onerror = function(event) {
                console.error("Speech recognition error", event.error);
                let msg = "è¾¨è­˜å¤±æ•—ï¼Œè«‹é‡è©¦";
                let color = "text-red-500";

                if(event.error === 'no-speech') {
                    msg = "æ²’è½åˆ°è²éŸ³ï¼Œè«‹å†è©¦ä¸€æ¬¡";
                } else if(event.error === 'not-allowed') {
                    msg = "è«‹å…è¨±éº¥å…‹é¢¨æ¬Šé™";
                } else if(event.error === 'network') {
                    msg = "ç¶²è·¯ä¸ç©©ï¼Œç„¡æ³•è¾¨è­˜";
                }
                
                const feedback = document.getElementById('feedback-area');
                feedback.textContent = msg;
                feedback.className = `h-6 mt-4 text-center text-sm font-bold ${color}`;
                stopRecordingUI();
            };

            recognition.onend = function() {
                if(isRecording) stopRecordingUI();
            };
        }

        async function toggleRecording() {
            const feedback = document.getElementById('feedback-area');
            const playBtn = document.getElementById('play-user-audio-btn');

            if (!recognition) {
                alert("æŠ±æ­‰ï¼Œæ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜åŠŸèƒ½ï¼Œè«‹ä½¿ç”¨ Chrome æˆ– Edge ç€è¦½å™¨ã€‚");
                return;
            }

            const btn = document.getElementById('record-btn');
            const text = document.getElementById('record-text');

            if (!isRecording) {
                // é–‹å§‹éŒ„éŸ³
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        if (audioURL) URL.revokeObjectURL(audioURL);
                        audioURL = URL.createObjectURL(audioBlob);
                        playBtn.classList.remove('hidden');
                    };

                    mediaRecorder.start();
                    recognition.start();
                    
                    isRecording = true;
                    btn.classList.remove('bg-red-100', 'text-red-500');
                    btn.classList.add('bg-red-500', 'text-white', 'recording-pulse');
                    text.textContent = "è†è½ä¸­...";
                    feedback.textContent = "è«‹å¤§è²å”¸å‡ºå–®å­—...";
                    feedback.className = "h-6 mt-4 text-center text-sm font-medium text-gray-500";
                    playBtn.classList.add('hidden');

                } catch(e) {
                    console.error("Recording start error:", e);
                    let msg = "ç„¡æ³•å­˜å–éº¥å…‹é¢¨";
                    if (window.location.protocol === 'file:') {
                        msg += " (è«‹å˜—è©¦å°‡æª”æ¡ˆæ”¾ä¸Šä¼ºæœå™¨æˆ–ä½¿ç”¨ localhost)";
                    }
                    alert(msg);
                    isRecording = false;
                    stopRecordingUI();
                }
            } else {
                recognition.stop();
                stopRecordingUI();
            }
        }

        function stopRecordingUI() {
            isRecording = false;
            
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }

            const btn = document.getElementById('record-btn');
            const text = document.getElementById('record-text');
            
            btn.classList.remove('bg-red-500', 'text-white', 'recording-pulse');
            btn.classList.add('bg-red-100', 'text-red-500');
            text.textContent = "è·Ÿè®€";
        }

        function playUserAudio() {
            if (audioURL) {
                const audio = new Audio(audioURL);
                audio.play();
            }
        }

        function evaluatePronunciation(spoken, target) {
            const cleanSpoken = spoken.toLowerCase().trim().replace(/[.,!?]/g, '');
            const cleanTarget = target.toLowerCase().trim().replace(/[.,!?]/g, '');
            
            const feedback = document.getElementById('feedback-area');
            let msg = "";
            let color = "";

            if (cleanSpoken === cleanTarget) {
                msg = "Excellent! ç™¼éŸ³å®Œå…¨æ­£ç¢ºï¼";
                color = "text-green-600";
                userData.speechCount++;
                saveData();
            } else if (cleanSpoken.includes(cleanTarget)) {
                msg = `Good Job! (è½åˆ°: ${cleanSpoken})`;
                color = "text-green-600";
                userData.speechCount++;
                saveData();
            } else {
                msg = `å†è©¦ä¸€æ¬¡ï¼Ÿ (è½åˆ°: ${cleanSpoken})`;
                color = "text-orange-500";
            }
            
            feedback.textContent = msg;
            feedback.className = `h-6 mt-4 text-center text-sm font-bold transition-all ${color}`;
        }

        // --- 6. éŠæˆ²é‚è¼¯ (Games) ---
        let activeLevel = 0; 

        function startGame(level) {
            activeLevel = level;
            document.getElementById('game-menu').classList.add('hidden');
            
            if (level === 1) {
                document.getElementById('game-level-1').classList.remove('hidden');
                startLevel1();
            } else if (level === 2) {
                document.getElementById('game-level-2').classList.remove('hidden');
                startLevel2();
            } else if (level === 3) {
                document.getElementById('game-level-3').classList.remove('hidden');
                startLevel3();
            }
        }

        function exitGame() {
            clearInterval(g2TimerInterval); 
            document.getElementById('game-level-1').classList.add('hidden');
            document.getElementById('game-level-2').classList.add('hidden');
            document.getElementById('game-level-3').classList.add('hidden');
            document.getElementById('game-menu').classList.remove('hidden');
            document.getElementById('game-modal').classList.add('hidden');
        }

        function retryGame() {
            document.getElementById('game-modal').classList.add('hidden');
            startGame(activeLevel);
        }

        function closeModalAndExit() {
            document.getElementById('game-modal').classList.add('hidden');
            exitGame();
        }

        // --- Level 1: é¸æ“‡é¡Œ ---
        let g1CurrentItem;
        let g1Score = 0;
        let g1Questions = []; 
        let g1Index = 0;      
        let g1QuestionStartTime = 0; 

        function startLevel1() {
            g1Score = 0;
            g1Index = 0;
            document.getElementById('g1-score').textContent = g1Score;
            g1Questions = [...vocabData].sort(() => Math.random() - 0.5).slice(0, 10);
            nextQuestionG1();
        }

        function nextQuestionG1() {
            if (g1Index >= g1Questions.length) {
                endLevel1();
                return;
            }

            document.getElementById('g1-progress').textContent = `${g1Index + 1} / ${g1Questions.length}`;
            document.getElementById('g1-feedback').textContent = "";
            
            g1CurrentItem = g1Questions[g1Index];
            
            document.getElementById('g1-question').textContent = g1CurrentItem.word;
            document.getElementById('g1-pos').textContent = g1CurrentItem.pos;

            let options = [g1CurrentItem.meaning];
            while (options.length < 4) {
                const wrongIdx = Math.floor(Math.random() * vocabData.length);
                const wrongMeaning = vocabData[wrongIdx].meaning;
                if (!options.includes(wrongMeaning)) {
                    options.push(wrongMeaning);
                }
            }
            options.sort(() => Math.random() - 0.5);

            const container = document.getElementById('g1-options');
            container.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full py-3 px-4 bg-gray-100 rounded-lg text-gray-700 font-medium hover:bg-blue-100 transition text-left";
                btn.textContent = opt;
                btn.onclick = () => checkAnswerG1(opt, btn);
                container.appendChild(btn);
            });

            g1QuestionStartTime = Date.now();
        }

        function checkAnswerG1(selected, btnElement) {
            if(btnElement.disabled) return;
            const allBtns = document.getElementById('g1-options').querySelectorAll('button');
            allBtns.forEach(b => b.disabled = true);

            const feedback = document.getElementById('g1-feedback');
            
            if (selected === g1CurrentItem.meaning) {
                const timeTaken = (Date.now() - g1QuestionStartTime) / 1000;
                let points = 100;
                let bonusMsg = "";

                if (timeTaken < 1.5) {
                    points += 50;
                    bonusMsg = " ğŸ”¥ç¥é€Ÿ!";
                } else if (timeTaken < 3.0) {
                    points += 30;
                    bonusMsg = " âš¡å¿«é€Ÿ!";
                } else if (timeTaken < 5.0) {
                    points += 10;
                }

                g1Score += points;
                document.getElementById('g1-score').textContent = g1Score;

                btnElement.classList.remove('bg-gray-100');
                btnElement.classList.add('bg-green-500', 'text-white');
                feedback.textContent = `Correct! +${points}åˆ†${bonusMsg}`;
                feedback.className = "mt-4 text-center font-bold h-6 text-green-600";
                
                setTimeout(() => {
                    g1Index++;
                    nextQuestionG1();
                }, 1000);

            } else {
                btnElement.classList.remove('bg-gray-100');
                btnElement.classList.add('bg-red-500', 'text-white');
                
                allBtns.forEach(b => {
                    if (b.textContent === g1CurrentItem.meaning) {
                        b.classList.remove('bg-gray-100');
                        b.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-300');
                    }
                });

                feedback.textContent = `Oops! æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${g1CurrentItem.meaning}`;
                feedback.className = "mt-4 text-center font-bold h-6 text-red-600";

                setTimeout(() => {
                    g1Index++;
                    nextQuestionG1();
                }, 1500);
            }
        }

        function endLevel1() {
            let feedback = "";
            let rank = "";
            
            if (g1Score >= 1300) {
                rank = "ğŸ† Sç´šï¼šå–®å­—å¤§å¸«";
                feedback = "å¤ªé©šäººäº†ï¼ä½ çš„åæ‡‰é€Ÿåº¦ç°¡ç›´æ˜¯é›»è…¦ç­‰ç´šï¼";
            } else if (g1Score >= 1000) {
                rank = "ğŸ¥‡ Aç´šï¼šè‹±èªé«˜æ‰‹";
                feedback = "éå¸¸å„ªç§€ï¼å°é€™äº›å–®å­—å·²ç¶“æŒæ¡å¾—å¾ˆå¥½äº†ï¼";
            } else if (g1Score >= 800) {
                rank = "ğŸ¥ˆ Bç´šï¼šæ½›åŠ›æ–°æ˜Ÿ";
                feedback = "å¾ˆæ£’çš„æˆç¸¾ï¼å†å¤šç·´ç¿’å¹¾æ¬¡å°±èƒ½æŒ‘æˆ°æ»¿åˆ†å›‰ï¼";
            } else {
                rank = "ğŸ¥‰ ç¹¼çºŒåŠ æ²¹";
                feedback = "åˆ¥ç°å¿ƒï¼Œç†Ÿèƒ½ç”Ÿå·§ï¼å»å–®å­—å¡å€å¤šè½å¹¾æ¬¡ç™¼éŸ³å§ï¼";
            }

            userData.history.unshift({
                date: new Date().toLocaleDateString(),
                action: `ç¬¬ 1 é—œæŒ‘æˆ° (å¾—åˆ†: ${g1Score})`
            });
            saveData();

            const modal = document.getElementById('game-modal');
            document.getElementById('modal-label').textContent = "æœ€çµ‚å¾—åˆ†";
            document.getElementById('modal-value').textContent = g1Score;
            document.getElementById('modal-feedback').innerHTML = `<span class="block font-bold text-lg mb-1">${rank}</span>${feedback}`;
            modal.classList.remove('hidden');
        }

        // --- Level 2: é…å°éŠæˆ² ---
        let g2Cards = [];
        let g2Selected = [];
        let g2Matches = 0;
        const G2_PAIRS = 6; 
        let g2TimerInterval = null;
        let g2StartTime = 0;

        function startLevel2() {
            g2Matches = 0;
            document.getElementById('g2-left').textContent = G2_PAIRS;
            
            clearInterval(g2TimerInterval);
            g2StartTime = Date.now();
            document.getElementById('g2-timer').textContent = "00:00";
            
            g2TimerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - g2StartTime) / 1000);
                const m = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const s = (elapsed % 60).toString().padStart(2, '0');
                document.getElementById('g2-timer').textContent = `${m}:${s}`;
            }, 1000);

            let gameWords = [...vocabData].sort(() => Math.random() - 0.5).slice(0, G2_PAIRS);
            
            let deck = [];
            gameWords.forEach((item, index) => {
                const wordLabel = `${item.word}\n(${item.pos})`;
                deck.push({ id: index, type: 'word', content: wordLabel, matchId: index });
                deck.push({ id: index, type: 'meaning', content: item.meaning, matchId: index });
            });
            deck.sort(() => Math.random() - 0.5);

            const grid = document.getElementById('g2-grid');
            grid.innerHTML = '';
            deck.forEach((card, idx) => {
                const el = document.createElement('div');
                el.className = "game-card bg-white border-2 border-purple-200 rounded-lg h-24 flex items-center justify-center p-2 text-center text-sm font-bold text-purple-800 shadow-sm hover:bg-purple-50 hover:shadow-md hover:-translate-y-1 transform transition-all whitespace-pre-line";
                el.dataset.idx = idx;
                el.textContent = card.content; 
                el.onclick = () => selectG2Card(el, card); 
                grid.appendChild(el);
            });
        }

        function selectG2Card(el, card) {
            if (el.classList.contains('matched') || g2Selected.some(s => s.el === el) || g2Selected.length >= 2) return;

            el.classList.remove('bg-white', 'text-purple-800', 'hover:bg-purple-50');
            el.classList.add('bg-purple-600', 'text-white', 'border-purple-600', 'scale-105');

            g2Selected.push({ el, card });

            if (g2Selected.length === 2) {
                checkMatch();
            }
        }

        function checkMatch() {
            const [first, second] = g2Selected;
            
            if (first.card.matchId === second.card.matchId && first.card.type !== second.card.type) {
                setTimeout(() => {
                    first.el.classList.add('opacity-0', 'pointer-events-none');
                    second.el.classList.add('opacity-0', 'pointer-events-none');
                    
                    g2Matches++;
                    document.getElementById('g2-left').textContent = G2_PAIRS - g2Matches;
                    
                    g2Selected = [];

                    if(g2Matches === G2_PAIRS) {
                        clearInterval(g2TimerInterval);
                        const finalTime = Math.floor((Date.now() - g2StartTime) / 1000);
                        
                        let feedback = "";
                        if(finalTime < 20) feedback = "å¤ªç¥äº†ï¼ç°¡ç›´æ˜¯å–®å­—é–ƒé›»ä¿ ï¼âš¡ğŸ†";
                        else if(finalTime < 40) feedback = "éå¸¸å„ªç§€ï¼åæ‡‰é€Ÿåº¦å¾ˆå¿«å–”ï¼ğŸŒŸ";
                        else if(finalTime < 60) feedback = "å¾ˆæ£’ï¼ç©©ç´®ç©©æ‰“å®Œæˆäº†æŒ‘æˆ°ï¼ğŸ‘";
                        else feedback = "æ­å–œå®Œæˆï¼å¤šç·´ç¿’å¹¾æ¬¡æœƒè¶Šä¾†è¶Šå¿«å–”ï¼ğŸ’ª";

                        userData.history.unshift({
                            date: new Date().toLocaleDateString(),
                            action: `ç¬¬ 2 é—œæŒ‘æˆ° (è€—æ™‚: ${finalTime}ç§’)`
                        });
                        saveData();

                        setTimeout(() => {
                            const modal = document.getElementById('game-modal');
                            document.getElementById('modal-label').textContent = "ç¸½è€—æ™‚";
                            document.getElementById('modal-value').textContent = `${finalTime} ç§’`;
                            document.getElementById('modal-feedback').textContent = feedback;
                            modal.classList.remove('hidden');
                        }, 500);
                    }
                }, 300);
            } else {
                setTimeout(() => {
                    [first, second].forEach(item => {
                        item.el.classList.remove('bg-purple-600', 'text-white', 'border-purple-600', 'scale-105');
                        item.el.classList.add('bg-white', 'text-purple-800', 'hover:bg-purple-50');
                    });
                    g2Selected = [];
                }, 600); 
            }
        }

        // --- Level 3: æ‹¼å­—éŠæˆ² ---
        let g3CurrentItem;
        let g3Score = 0;
        let g3Questions = [];
        let g3Index = 0;

        function startLevel3() {
            g3Score = 0;
            g3Index = 0;
            document.getElementById('g3-score').textContent = g3Score;
            
            // éš¨æ©Ÿé¸ 5 é¡Œ
            g3Questions = [...vocabData].sort(() => Math.random() - 0.5).slice(0, 5);
            nextQuestionG3();
        }

        function nextQuestionG3() {
            if (g3Index >= g3Questions.length) {
                endLevel3();
                return;
            }

            document.getElementById('g3-progress').textContent = `${g3Index + 1} / ${g3Questions.length}`;
            document.getElementById('g3-feedback').textContent = "";
            
            g3CurrentItem = g3Questions[g3Index];
            
            document.getElementById('g3-pos').textContent = g3CurrentItem.pos;
            document.getElementById('g3-meaning').textContent = g3CurrentItem.meaning;
            
            const input = document.getElementById('g3-input');
            input.value = "";
            input.disabled = false;
            input.classList.remove('border-green-500', 'text-green-600', 'border-red-500', 'text-red-600');
            input.focus();
        }

        function checkAnswerG3() {
            const input = document.getElementById('g3-input');
            const feedback = document.getElementById('g3-feedback');
            
            // é˜²æ­¢é‡è¤‡æäº¤
            if(input.disabled) return;

            const userSpelling = input.value.trim().toLowerCase();
            const correctSpelling = g3CurrentItem.word.toLowerCase();

            input.disabled = true;

            if (userSpelling === correctSpelling) {
                // ç­”å°
                g3Score += 200;
                document.getElementById('g3-score').textContent = g3Score;
                
                input.classList.add('border-green-500', 'text-green-600');
                feedback.textContent = "Correct! æ‹¼å­—æ­£ç¢ºï¼";
                feedback.className = "mt-2 text-center font-bold text-green-600";
                
                setTimeout(() => {
                    g3Index++;
                    nextQuestionG3();
                }, 1000);
            } else {
                // ç­”éŒ¯
                input.classList.add('border-red-500', 'text-red-600', 'shake'); // åŠ å…¥éœ‡å‹•ç‰¹æ•ˆ
                feedback.textContent = `Correct answer: ${g3CurrentItem.word}`;
                feedback.className = "mt-2 text-center font-bold text-red-600";
                
                // ç§»é™¤éœ‡å‹• class ä»¥ä¾¿ä¸‹æ¬¡è§¸ç™¼
                setTimeout(() => input.classList.remove('shake'), 500);

                setTimeout(() => {
                    g3Index++;
                    nextQuestionG3();
                }, 2000); // éŒ¯é¡Œçµ¦å¤šä¸€é»æ™‚é–“çœ‹æ­£ç¢ºç­”æ¡ˆ
            }
        }

        function endLevel3() {
            let feedback = "";
            let rank = "";
            
            if (g3Score === 1000) {
                rank = "ğŸ† æ‹¼å­—ä¹‹ç¥";
                feedback = "å¤ªå¼·äº†ï¼å…¨éƒ¨ç­”å°ï¼Œä½ çš„æ‹¼å­—èƒ½åŠ›ç„¡æ‡ˆå¯æ“Šï¼";
            } else if (g3Score >= 800) {
                rank = "ğŸ¥‡ æ‹¼å­—é«˜æ‰‹";
                feedback = "éå¸¸å²å®³ï¼åªæœ‰ä¸€é»é»å°å¤±èª¤ï¼Œç¹¼çºŒä¿æŒï¼";
            } else if (g3Score >= 600) {
                rank = "ğŸ¥ˆ æ‹¼å­—é”äºº";
                feedback = "ä¸éŒ¯å–”ï¼å¤§éƒ¨åˆ†å–®å­—éƒ½è¨˜ä½äº†ï¼ŒåŠ æ²¹ï¼";
            } else {
                rank = "ğŸ¥‰ ç¹¼çºŒåŠªåŠ›";
                feedback = "æ‹¼å­—ç¢ºå¯¦ä¸å®¹æ˜“ï¼Œå¤šç©å¹¾æ¬¡å°±æœƒè¨˜ä½å›‰ï¼";
            }

            userData.history.unshift({
                date: new Date().toLocaleDateString(),
                action: `ç¬¬ 3 é—œæŒ‘æˆ° (å¾—åˆ†: ${g3Score})`
            });
            saveData();

            const modal = document.getElementById('game-modal');
            document.getElementById('modal-label').textContent = "æ‹¼å­—å¾—åˆ†";
            document.getElementById('modal-value').textContent = g3Score;
            document.getElementById('modal-feedback').innerHTML = `<span class="block font-bold text-lg mb-1">${rank}</span>${feedback}`;
            modal.classList.remove('hidden');
        }

        // --- 7. å­¸ç¿’æ­·ç¨‹ (Stats) ---
        function updateStats() {
            document.getElementById('stat-learned').textContent = userData.learned.length;
            document.getElementById('stat-speech').textContent = userData.speechCount;
            renderLearnedWords(); 
        }

        function renderLearnedWords() {
            const container = document.getElementById('learned-word-list');
            if (!container) return;
            container.innerHTML = '';

            if (userData.learned.length === 0) {
                container.innerHTML = '<span class="text-gray-400 text-sm py-2">å°šæœªé–‹å§‹å­¸ç¿’ï¼Œå¿«å»å–®å­—å¡å€ç¿»ç¿»çœ‹å§ï¼</span>';
                return;
            }

            const learnedItems = vocabData
                .filter(item => userData.learned.includes(item.id))
                .sort((a, b) => a.id - b.id);
            
            learnedItems.forEach(item => {
                const el = document.createElement('span');
                el.className = "inline-flex items-center px-3 py-1.5 rounded-lg text-sm bg-teal-50 text-teal-800 border border-teal-100 hover:bg-teal-100 transition shadow-sm";
                el.innerHTML = `
                    <span class="font-bold mr-2">${item.word}</span>
                    <span class="text-xs text-gray-500 border-l border-teal-200 pl-2">${item.meaning}</span>
                `;
                container.appendChild(el);
            });
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            
            if (userData.history.length === 0) {
                list.innerHTML = '<li class="text-gray-400 text-center py-4">ç›®å‰å°šç„¡ç´€éŒ„ï¼Œå¿«å»ç·´ç¿’å§ï¼</li>';
                return;
            }

            userData.history.slice(0, 10).forEach(h => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center py-2 border-b border-gray-50 last:border-0";
                li.innerHTML = `
                    <span class="text-gray-700 font-medium">${h.action}</span>
                    <span class="text-xs text-gray-400">${h.date}</span>
                `;
                list.appendChild(li);
            });
        }

        function resetProgress() {
            if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å­¸ç¿’èˆ‡ç™¼éŸ³ç´€éŒ„å—ï¼Ÿç„¡æ³•å¾©åŸå–”ï¼")) {
                userData = { learned: [], speechCount: 0, history: [] };
                saveData();
                renderCard();
                updateStats(); 
                renderHistory();
            }
        }

    </script>
</body>
</html>